<script>
    import BoxButton from './BoxButton.svelte';
    import PostData from '$lib/stores/PostData';
	import Slider from '@bulatdashiev/svelte-slider';
    import { onMount } from 'svelte';
    import { fade, scale } from 'svelte/transition';
    import { cubicOut } from 'svelte/easing';
    import PostDataMulti from '$lib/stores/PostDataMulti';
    import PostDataRanking from '$lib/stores/PostDataRanking';
    import DropDownData from '$lib/stores/DropDownData';
    import CurrentFrame from '$lib/stores/CurrentFrame';
    import DropDownDataRanking from '$lib/stores/DropDownDataRanking';
    import DropDownDataScore from '$lib/stores/DropDownDataScore';
    import PostDataScore from '$lib/stores/PostDataScore';

    let value = [25, 100];
    let blurValue = [0, 100];


    $: postData = $CurrentFrame == "pickems" ? $DropDownData[0].active == 2 ? PostDataMulti :  PostData :  $CurrentFrame == "ranking" ? PostDataRanking : PostDataScore;
    
    $: if(value[0]){
        $postData.BackgroundImageUrlBrightness = value[0];
    }
    $: if(blurValue[0]){
        $postData.BackgroundImageUrlBlur = blurValue[0];
    }

    let mounted = false;

    onMount(() => {
        mounted = true;
    });

    let imageFetching = false;

    let showBgDetails = false;

    function toggleBgDetails() {
        showBgDetails = !showBgDetails;
    }

    function addImage() {
        imageFetching = true;
        console.log('Adding image...');
        window.parent.postMessage({
            type: 'addImage'
        }, '*');
    }

    function resetImage() {
        $postData.BackgroundImageUrl = '';
    }

    const handleMessage = (ev) => {
        if (!imageFetching) return;
        const { type, data } = ev.data;

        if (type === 'devvit-message') {
            const { message } = data;

            if (message.type === 'imageUploaded') {
                // $ShowLoader = true

                console.log('Image uploaded:', message.data.imageUrl);
                const checkImageUrl = async () => {
                    try {
                        const response = await fetch(message.data.imageUrl);
                        if (response.status === 404) {
                            setTimeout(checkImageUrl, 500);
                        } else {

                            console.log('Image exists:', message.data.imageUrl);
                            $postData.BackgroundImageUrl = message.data.imageUrl;
                            // $ShowLoader = false

                        }
                    } catch (error) {
                        console.error('Error checking image URL:', error);
                        setTimeout(checkImageUrl, 500);
                    }
                };

                checkImageUrl();
                imageFetching = false;
            }
            
        }
    };

    let dropDownElement = null

    function trimBackgroundImageUrl() {
        // Access the URL from PostData
        const url = $postData.BackgroundImageUrl;
        
        // Check if the URL exists
        if (!url) {
            return "";
        }
        
        // Check if URL is longer than 20 characters
        if (url.length > 20) {
            // Trim to 20 characters and add "..."
            return url.substring(0, 15) + "...";
        }
        
        // Return the full URL if it's 20 characters or less
        return url;
    }
</script>
<svelte:window 
on:message={handleMessage}
on:click={(e) => {!dropDownElement.contains(e.target) ? showBgDetails = false:'' } }/>


<div bind:this={dropDownElement}  class=" {$DropDownDataScore[0]?.active  == 0 && !$PostDataScore.BackgroundImageUrl ? "text-[white]":""} z-[15] pointer-events-auto  relative">
    <button on:click={toggleBgDetails} class="{$DropDownDataScore[0]?.active  == 0 && !$PostDataScore.BackgroundImageUrl ? "text-[black]":""}  cursor-pointer pointer-events-auto  text-[2em] xsm:text-[1em] relative size-[0.72em] block ml-auto">
        <BoxButton>
            <div class="leading-0 text-[0.78em] size-[0.8em] absolute top-1/2 left-1/2 -translate-1/2">
                <svg  viewBox="0 0 15 7" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0.101562 6.98438H14.8953L10.2723 0.820312L6.57383 5.75156L3.8 2.05313L0.101562 6.98438Z" fill="{$DropDownDataScore[0]?.active  == 0 && !$PostDataScore.BackgroundImageUrl ? "#000":"#fff"}"/>
                </svg>
            </div>
        </BoxButton>
    </button>

    {#if showBgDetails}
        <div transition:fade={{duration:400, easing: cubicOut}} class="text-[1.5em] xsm:text-[1em]  font-semibold { $DropDownDataRanking[0]?.active  == 0 ? "font-inter ":"font-bigShoulders" } uppercase absolute top-full mt-[0.5em] right-[-5px]  bg-[#2a2320]">
            <div class="text-[0.5em] p-[0.5em] space-y-0hem">
                <!-- svelte-ignore a11y_click_events_have_key_events -->
                <div transition:scale={{start:0.9, duration:400, easing: cubicOut}} class="flex justify-center items-center gap-[0.5em]">
                    <!-- svelte-ignore a11y_click_events_have_key_events -->
                    <!-- svelte-ignore a11y_no_static_element_interactions -->
                    <button on:click={addImage} class="uppercase cursor-pointer grow px-[0.6em] text-center bg-[#00000046] p-[0.4em] w-[12em]">
                        {trimBackgroundImageUrl() || "add bg image"} 
                    </button>
                    <!-- svelte-ignore a11y_consider_explicit_label -->
                    {#if $postData.BackgroundImageUrl}
                        <button on:click={resetImage} class="bg-[#00000046] p-[0.6em] size-[2.2em]">
                            <svg viewBox="0 0 18 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3.58203 19.75C2.9862 19.75 2.47613 19.5378 2.05182 19.1135C1.62752 18.6892 1.41536 18.1792 1.41536 17.5833V3.5H0.332031V1.33333H5.7487V0.25H12.2487V1.33333H17.6654V3.5H16.582V17.5833C16.582 18.1792 16.3699 18.6892 15.9456 19.1135C15.5213 19.5378 15.0112 19.75 14.4154 19.75H3.58203ZM14.4154 3.5H3.58203V17.5833H14.4154V3.5ZM5.7487 15.4167H7.91536V5.66667H5.7487V15.4167ZM10.082 15.4167H12.2487V5.66667H10.082V15.4167Z" fill="white"/>
                            </svg>                                                     
                        </button>
                    {/if}
                </div>
                {#if $postData.BackgroundImageUrl}
                    <!-- svelte-ignore a11y_click_events_have_key_events -->
                    <div transition:scale={{start:0.9, duration:400, easing: cubicOut}} class="flex justify-center items-center gap-[0.5em]">
                        <!-- svelte-ignore a11y_click_events_have_key_events -->
                        <!-- svelte-ignore a11y_no_static_element_interactions -->
                        <div class="relative uppercase cursor-pointer px-[0.6em] text-center bg-[#00000046] p-[0.4em] w-[12em] h-[2.2em]">
                            <div class="absolute pl-[1.3em] top-1/2 left-1/2 -translate-1/2 w-[100%]">
                                <div class="relative w-full">
                                    {#if mounted}
                                        <Slider bind:value>
                                            <span slot="left" class="px-1em text-[0.8em] translate-y-[-0.01em] block">|</span>
                                        </Slider>
                                    {/if}
                                </div>
                            </div>
                        </div>
                        <!-- svelte-ignore a11y_consider_explicit_label -->
                        <button class="bg-[#00000046] p-[0.6em] size-[2.2em]">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12.1789 23.2992L8.82891 19.9992H4.17891V15.3492L0.878906 11.9992L4.17891 8.64922V3.99922H8.82891L12.1789 0.699219L15.5289 3.99922H20.1789V8.64922L23.4789 11.9992L20.1789 15.3492V19.9992H15.5289L12.1789 23.2992ZM12.1789 16.9992C13.5622 16.9992 14.7414 16.5117 15.7164 15.5367C16.6914 14.5617 17.1789 13.3826 17.1789 11.9992C17.1789 10.6159 16.6914 9.43672 15.7164 8.46172C14.7414 7.48672 13.5622 6.99922 12.1789 6.99922V16.9992ZM12.1789 20.4992L14.6789 17.9992H18.1789V14.4992L20.6789 11.9992L18.1789 9.49922V5.99922H14.6789L12.1789 3.49922L9.67891 5.99922H6.17891V9.49922L3.67891 11.9992L6.17891 14.4992V17.9992H9.67891L12.1789 20.4992Z" fill="white"/>
                            </svg>                                                                              
                        </button>
                    </div>
                    <div transition:scale={{start:0.9, duration:400, easing: cubicOut}} class="flex justify-center items-center gap-[0.5em]">
                        <!-- svelte-ignore a11y_click_events_have_key_events -->
                        <!-- svelte-ignore a11y_no_static_element_interactions -->
                        <div class="relative uppercase cursor-pointer px-[0.6em] text-center bg-[#00000046] p-[0.4em] w-[12em] h-[2.2em]">
                            <div class="absolute pl-[1.3em] top-1/2 left-1/2 -translate-1/2 w-[100%]">
                                <div class="relative w-full">
                                    {#if mounted}
                                        <Slider bind:value={blurValue}>
                                            <span slot="left" class="text-[0.8em] translate-y-[-0.01em] block">|</span>
                                        </Slider>
                                    {/if}
                                </div>
                            </div>
                        </div>
                        <!-- svelte-ignore a11y_consider_explicit_label -->
                        <button class="bg-[#00000046] p-[0.6em] size-[2.2em]">
                            <svg  viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1.28516 12.1328C1.15182 12.1328 1.03516 12.0828 0.935156 11.9828C0.835156 11.8828 0.785156 11.7661 0.785156 11.6328C0.785156 11.4995 0.835156 11.3828 0.935156 11.2828C1.03516 11.1828 1.15182 11.1328 1.28516 11.1328C1.41849 11.1328 1.53516 11.1828 1.63516 11.2828C1.73516 11.3828 1.78516 11.4995 1.78516 11.6328C1.78516 11.7661 1.73516 11.8828 1.63516 11.9828C1.53516 12.0828 1.41849 12.1328 1.28516 12.1328ZM1.28516 8.13281C1.15182 8.13281 1.03516 8.08281 0.935156 7.98281C0.835156 7.88281 0.785156 7.76615 0.785156 7.63281C0.785156 7.49948 0.835156 7.38281 0.935156 7.28281C1.03516 7.18281 1.15182 7.13281 1.28516 7.13281C1.41849 7.13281 1.53516 7.18281 1.63516 7.28281C1.73516 7.38281 1.78516 7.49948 1.78516 7.63281C1.78516 7.76615 1.73516 7.88281 1.63516 7.98281C1.53516 8.08281 1.41849 8.13281 1.28516 8.13281ZM4.28516 16.6328C4.00182 16.6328 3.76432 16.537 3.57266 16.3453C3.38099 16.1536 3.28516 15.9161 3.28516 15.6328C3.28516 15.3495 3.38099 15.112 3.57266 14.9203C3.76432 14.7286 4.00182 14.6328 4.28516 14.6328C4.56849 14.6328 4.80599 14.7286 4.99766 14.9203C5.18932 15.112 5.28516 15.3495 5.28516 15.6328C5.28516 15.9161 5.18932 16.1536 4.99766 16.3453C4.80599 16.537 4.56849 16.6328 4.28516 16.6328ZM4.28516 12.6328C4.00182 12.6328 3.76432 12.537 3.57266 12.3453C3.38099 12.1536 3.28516 11.9161 3.28516 11.6328C3.28516 11.3495 3.38099 11.112 3.57266 10.9203C3.76432 10.7286 4.00182 10.6328 4.28516 10.6328C4.56849 10.6328 4.80599 10.7286 4.99766 10.9203C5.18932 11.112 5.28516 11.3495 5.28516 11.6328C5.28516 11.9161 5.18932 12.1536 4.99766 12.3453C4.80599 12.537 4.56849 12.6328 4.28516 12.6328ZM4.28516 8.63281C4.00182 8.63281 3.76432 8.53698 3.57266 8.34531C3.38099 8.15365 3.28516 7.91615 3.28516 7.63281C3.28516 7.34948 3.38099 7.11198 3.57266 6.92031C3.76432 6.72865 4.00182 6.63281 4.28516 6.63281C4.56849 6.63281 4.80599 6.72865 4.99766 6.92031C5.18932 7.11198 5.28516 7.34948 5.28516 7.63281C5.28516 7.91615 5.18932 8.15365 4.99766 8.34531C4.80599 8.53698 4.56849 8.63281 4.28516 8.63281ZM4.28516 4.63281C4.00182 4.63281 3.76432 4.53698 3.57266 4.34531C3.38099 4.15365 3.28516 3.91615 3.28516 3.63281C3.28516 3.34948 3.38099 3.11198 3.57266 2.92031C3.76432 2.72865 4.00182 2.63281 4.28516 2.63281C4.56849 2.63281 4.80599 2.72865 4.99766 2.92031C5.18932 3.11198 5.28516 3.34948 5.28516 3.63281C5.28516 3.91615 5.18932 4.15365 4.99766 4.34531C4.80599 4.53698 4.56849 4.63281 4.28516 4.63281ZM8.28516 13.1328C7.86849 13.1328 7.51432 12.987 7.22266 12.6953C6.93099 12.4036 6.78516 12.0495 6.78516 11.6328C6.78516 11.2161 6.93099 10.862 7.22266 10.5703C7.51432 10.2786 7.86849 10.1328 8.28516 10.1328C8.70182 10.1328 9.05599 10.2786 9.34766 10.5703C9.63932 10.862 9.78516 11.2161 9.78516 11.6328C9.78516 12.0495 9.63932 12.4036 9.34766 12.6953C9.05599 12.987 8.70182 13.1328 8.28516 13.1328ZM8.28516 9.13281C7.86849 9.13281 7.51432 8.98698 7.22266 8.69531C6.93099 8.40365 6.78516 8.04948 6.78516 7.63281C6.78516 7.21615 6.93099 6.86198 7.22266 6.57031C7.51432 6.27865 7.86849 6.13281 8.28516 6.13281C8.70182 6.13281 9.05599 6.27865 9.34766 6.57031C9.63932 6.86198 9.78516 7.21615 9.78516 7.63281C9.78516 8.04948 9.63932 8.40365 9.34766 8.69531C9.05599 8.98698 8.70182 9.13281 8.28516 9.13281ZM8.28516 16.6328C8.00182 16.6328 7.76432 16.537 7.57266 16.3453C7.38099 16.1536 7.28516 15.9161 7.28516 15.6328C7.28516 15.3495 7.38099 15.112 7.57266 14.9203C7.76432 14.7286 8.00182 14.6328 8.28516 14.6328C8.56849 14.6328 8.80599 14.7286 8.99766 14.9203C9.18932 15.112 9.28516 15.3495 9.28516 15.6328C9.28516 15.9161 9.18932 16.1536 8.99766 16.3453C8.80599 16.537 8.56849 16.6328 8.28516 16.6328ZM8.28516 4.63281C8.00182 4.63281 7.76432 4.53698 7.57266 4.34531C7.38099 4.15365 7.28516 3.91615 7.28516 3.63281C7.28516 3.34948 7.38099 3.11198 7.57266 2.92031C7.76432 2.72865 8.00182 2.63281 8.28516 2.63281C8.56849 2.63281 8.80599 2.72865 8.99766 2.92031C9.18932 3.11198 9.28516 3.34948 9.28516 3.63281C9.28516 3.91615 9.18932 4.15365 8.99766 4.34531C8.80599 4.53698 8.56849 4.63281 8.28516 4.63281ZM8.28516 19.1328C8.15182 19.1328 8.03516 19.0828 7.93516 18.9828C7.83516 18.8828 7.78516 18.7661 7.78516 18.6328C7.78516 18.4995 7.83516 18.3828 7.93516 18.2828C8.03516 18.1828 8.15182 18.1328 8.28516 18.1328C8.41849 18.1328 8.53516 18.1828 8.63516 18.2828C8.73516 18.3828 8.78516 18.4995 8.78516 18.6328C8.78516 18.7661 8.73516 18.8828 8.63516 18.9828C8.53516 19.0828 8.41849 19.1328 8.28516 19.1328ZM8.28516 1.13281C8.15182 1.13281 8.03516 1.08281 7.93516 0.982813C7.83516 0.882813 7.78516 0.766146 7.78516 0.632813C7.78516 0.499479 7.83516 0.382813 7.93516 0.282813C8.03516 0.182813 8.15182 0.132812 8.28516 0.132812C8.41849 0.132812 8.53516 0.182813 8.63516 0.282813C8.73516 0.382813 8.78516 0.499479 8.78516 0.632813C8.78516 0.766146 8.73516 0.882813 8.63516 0.982813C8.53516 1.08281 8.41849 1.13281 8.28516 1.13281ZM12.2852 13.1328C11.8685 13.1328 11.5143 12.987 11.2227 12.6953C10.931 12.4036 10.7852 12.0495 10.7852 11.6328C10.7852 11.2161 10.931 10.862 11.2227 10.5703C11.5143 10.2786 11.8685 10.1328 12.2852 10.1328C12.7018 10.1328 13.056 10.2786 13.3477 10.5703C13.6393 10.862 13.7852 11.2161 13.7852 11.6328C13.7852 12.0495 13.6393 12.4036 13.3477 12.6953C13.056 12.987 12.7018 13.1328 12.2852 13.1328ZM12.2852 9.13281C11.8685 9.13281 11.5143 8.98698 11.2227 8.69531C10.931 8.40365 10.7852 8.04948 10.7852 7.63281C10.7852 7.21615 10.931 6.86198 11.2227 6.57031C11.5143 6.27865 11.8685 6.13281 12.2852 6.13281C12.7018 6.13281 13.056 6.27865 13.3477 6.57031C13.6393 6.86198 13.7852 7.21615 13.7852 7.63281C13.7852 8.04948 13.6393 8.40365 13.3477 8.69531C13.056 8.98698 12.7018 9.13281 12.2852 9.13281ZM12.2852 16.6328C12.0018 16.6328 11.7643 16.537 11.5727 16.3453C11.381 16.1536 11.2852 15.9161 11.2852 15.6328C11.2852 15.3495 11.381 15.112 11.5727 14.9203C11.7643 14.7286 12.0018 14.6328 12.2852 14.6328C12.5685 14.6328 12.806 14.7286 12.9977 14.9203C13.1893 15.112 13.2852 15.3495 13.2852 15.6328C13.2852 15.9161 13.1893 16.1536 12.9977 16.3453C12.806 16.537 12.5685 16.6328 12.2852 16.6328ZM12.2852 4.63281C12.0018 4.63281 11.7643 4.53698 11.5727 4.34531C11.381 4.15365 11.2852 3.91615 11.2852 3.63281C11.2852 3.34948 11.381 3.11198 11.5727 2.92031C11.7643 2.72865 12.0018 2.63281 12.2852 2.63281C12.5685 2.63281 12.806 2.72865 12.9977 2.92031C13.1893 3.11198 13.2852 3.34948 13.2852 3.63281C13.2852 3.91615 13.1893 4.15365 12.9977 4.34531C12.806 4.53698 12.5685 4.63281 12.2852 4.63281ZM12.2852 19.1328C12.1518 19.1328 12.0352 19.0828 11.9352 18.9828C11.8352 18.8828 11.7852 18.7661 11.7852 18.6328C11.7852 18.4995 11.8352 18.3828 11.9352 18.2828C12.0352 18.1828 12.1518 18.1328 12.2852 18.1328C12.4185 18.1328 12.5352 18.1828 12.6352 18.2828C12.7352 18.3828 12.7852 18.4995 12.7852 18.6328C12.7852 18.7661 12.7352 18.8828 12.6352 18.9828C12.5352 19.0828 12.4185 19.1328 12.2852 19.1328ZM12.2852 1.13281C12.1518 1.13281 12.0352 1.08281 11.9352 0.982813C11.8352 0.882813 11.7852 0.766146 11.7852 0.632813C11.7852 0.499479 11.8352 0.382813 11.9352 0.282813C12.0352 0.182813 12.1518 0.132812 12.2852 0.132812C12.4185 0.132812 12.5352 0.182813 12.6352 0.282813C12.7352 0.382813 12.7852 0.499479 12.7852 0.632813C12.7852 0.766146 12.7352 0.882813 12.6352 0.982813C12.5352 1.08281 12.4185 1.13281 12.2852 1.13281ZM16.2852 16.6328C16.0018 16.6328 15.7643 16.537 15.5727 16.3453C15.381 16.1536 15.2852 15.9161 15.2852 15.6328C15.2852 15.3495 15.381 15.112 15.5727 14.9203C15.7643 14.7286 16.0018 14.6328 16.2852 14.6328C16.5685 14.6328 16.806 14.7286 16.9977 14.9203C17.1893 15.112 17.2852 15.3495 17.2852 15.6328C17.2852 15.9161 17.1893 16.1536 16.9977 16.3453C16.806 16.537 16.5685 16.6328 16.2852 16.6328ZM16.2852 12.6328C16.0018 12.6328 15.7643 12.537 15.5727 12.3453C15.381 12.1536 15.2852 11.9161 15.2852 11.6328C15.2852 11.3495 15.381 11.112 15.5727 10.9203C15.7643 10.7286 16.0018 10.6328 16.2852 10.6328C16.5685 10.6328 16.806 10.7286 16.9977 10.9203C17.1893 11.112 17.2852 11.3495 17.2852 11.6328C17.2852 11.9161 17.1893 12.1536 16.9977 12.3453C16.806 12.537 16.5685 12.6328 16.2852 12.6328ZM16.2852 8.63281C16.0018 8.63281 15.7643 8.53698 15.5727 8.34531C15.381 8.15365 15.2852 7.91615 15.2852 7.63281C15.2852 7.34948 15.381 7.11198 15.5727 6.92031C15.7643 6.72865 16.0018 6.63281 16.2852 6.63281C16.5685 6.63281 16.806 6.72865 16.9977 6.92031C17.1893 7.11198 17.2852 7.34948 17.2852 7.63281C17.2852 7.91615 17.1893 8.15365 16.9977 8.34531C16.806 8.53698 16.5685 8.63281 16.2852 8.63281ZM16.2852 4.63281C16.0018 4.63281 15.7643 4.53698 15.5727 4.34531C15.381 4.15365 15.2852 3.91615 15.2852 3.63281C15.2852 3.34948 15.381 3.11198 15.5727 2.92031C15.7643 2.72865 16.0018 2.63281 16.2852 2.63281C16.5685 2.63281 16.806 2.72865 16.9977 2.92031C17.1893 3.11198 17.2852 3.34948 17.2852 3.63281C17.2852 3.91615 17.1893 4.15365 16.9977 4.34531C16.806 4.53698 16.5685 4.63281 16.2852 4.63281ZM19.2852 12.1328C19.1518 12.1328 19.0352 12.0828 18.9352 11.9828C18.8352 11.8828 18.7852 11.7661 18.7852 11.6328C18.7852 11.4995 18.8352 11.3828 18.9352 11.2828C19.0352 11.1828 19.1518 11.1328 19.2852 11.1328C19.4185 11.1328 19.5352 11.1828 19.6352 11.2828C19.7352 11.3828 19.7852 11.4995 19.7852 11.6328C19.7852 11.7661 19.7352 11.8828 19.6352 11.9828C19.5352 12.0828 19.4185 12.1328 19.2852 12.1328ZM19.2852 8.13281C19.1518 8.13281 19.0352 8.08281 18.9352 7.98281C18.8352 7.88281 18.7852 7.76615 18.7852 7.63281C18.7852 7.49948 18.8352 7.38281 18.9352 7.28281C19.0352 7.18281 19.1518 7.13281 19.2852 7.13281C19.4185 7.13281 19.5352 7.18281 19.6352 7.28281C19.7352 7.38281 19.7852 7.49948 19.7852 7.63281C19.7852 7.76615 19.7352 7.88281 19.6352 7.98281C19.5352 8.08281 19.4185 8.13281 19.2852 8.13281Z" fill="#E3E3E3"/>
                            </svg>                                                                                                         
                        </button>
                    </div>
                {/if}
            </div>
            
        </div>
    {/if}
</div>


<style>
	div {
		--thumb-bg: transparent;
		--progress-bg: #fcfcfc;
		--track-bg: #454545;
	}
</style>